import asyncio
import os
import json
from dotenv import load_dotenv
from app.services.analyzer import analyze_text

load_dotenv()

TEST_TEXT = """郭靖背着黄蓉，一路向南，尽拣荒僻小径行走，这日午后到了一处山谷。忽闻远处钟声清亮，黄蓉喜道：“靖哥哥，前面定有寺庙，咱们去求些斋饭，再问问一灯大师的下落。”
郭靖依言寻去，果见一座古刹，山门匾额上书 “宝光寺” 三字。两人进了山门，一名老僧迎了上来，合什问道：“施主从何而来？光临小寺有何贵干？”
黄蓉在郭靖背上说道：“老法师，我们是来求见一灯大师的，还望通报。”
老僧闻言脸色微变，摇头道：“施主认错了，这里只有宝光寺，并无什么一灯大师。”
郭靖急道：“我们千里迢迢而来，听闻一灯大师隐居此间，还望法师行个方便。”
老僧叹了口气：“不是老僧不肯通融，实在是大师嘱咐过，不见外间俗客。施主请回吧。” 说罢便要转身。
黄蓉忙道：“老法师，我身中剧毒，唯有一灯大师的一阳指能救，若见不到大师，不出三日我便性命难保。” 她声音微弱，带着哀求之意。
老僧迟疑片刻，道：“大师行医救人，本是慈悲为怀，可他近年潜心修行，早已不问世事。你们还是走吧。”
黄蓉忽道：“我知道大师曾是大理段皇爷，当年为刘贵妃舍弃江山，这份情谊，难道就不能再发一次恻隐之心？”
老僧身子一震，惊道：“你这小女娃，倒知道不少事。只是大师心意已决，我劝你们莫要再纠缠了。”
就在这时，寺内走出一名中年僧人，喝道：“法明，与他们多说什么！” 他转向郭靖黄蓉，眼神凌厉，“段皇爷早已圆寂，你们再在此胡闹，休怪我不客气！”
黄蓉冷笑一声：“大师若真圆寂了，为何寺中藏着大理段氏的先天功气息？这位大师，你既是渔樵耕读中的‘读’，何必故作玄虚？”
那中年僧人正是朱子柳，闻言脸色一变：“你这丫头倒是有些见识。不过就算你认出我，想见师父也是痴心妄想。”
郭靖忙道：“朱大师，救人一命胜造七级浮屠，还请你成全。”
朱子柳道：“并非我不肯，只是师父为救世人，耗损内力甚多，实在不宜再动真气。你们请回吧。”
黄蓉道：“我知道大师曾为救黄蓉，耗费功力疗伤。可我这伤，若大师不出手，我便死定了。我爹爹是黄药师，若我身死，爹爹定然不会善罢甘休，到时只怕这宝光寺也难安宁。”
朱子柳怒道：“你这是威胁我？黄药师又如何，难道我们还怕了他不成？”
黄蓉轻轻咳嗽几声，道：“我并非威胁，只是实话实说。何况我也并非贪生怕死，只是靖哥哥为我奔波劳累，我若死了，他一人孤苦伶仃，实在可怜。”
郭靖听得眼眶发红，道：“蓉儿，你别胡说，我定会找到大师救你的。”
朱子柳见两人情真意切，心中微动，沉吟道：“罢了，我去通报师父一声，至于见不见，全看师父的意思。你们在此等候。”
两人谢过朱子柳，在殿外等候。不多时，朱子柳匆匆回来，道：“师父请你们进去。”
郭靖大喜，背着黄蓉跟着朱子柳来到后院一间禅房。禅房内，一名白须老僧盘膝而坐，面容慈祥，正是一灯大师。
黄蓉道：“弟子黄蓉，拜见一灯大师。”
一灯大师缓缓睁眼，目光落在黄蓉身上，叹道：“女娃，你身上中的是铁掌帮的铁砂掌剧毒，还夹杂着西域奇毒，已然侵入五脏六腑，当真凶险。”
郭靖忙道：“大师，求你救救蓉儿。”
一灯大师点头道：“出家人以慈悲为怀，自然不会见死不救。只是这疗伤需耗费我十年功力，我若疗伤，日后再难行侠仗义了。”
黄蓉道：“大师若肯相救，弟子愿以任何代价报答。”
一灯大师微微一笑：“我救人从不求回报。只是我疗伤之时，若有人打扰，不仅你性命难保，我也会身受重伤。你那几位师父，可得护好禅房。”
郭靖道：“大师放心，我定会拼死守护。”
正说着，门外忽然传来一声冷笑：“段智兴，你今日救人，明日便要化作一堆白骨了！” 话音未落，一人破窗而入，正是裘千仞。
一灯大师神色不变，道：“裘帮主，多年不见，你还是这般好勇斗狠。”
裘千仞道：“当年你坏我好事，今日我便要取你性命，顺便了结了这小丫头。” 说着便挥掌向一灯大师拍去。
郭靖见状，立刻挥拳迎上，喝道：“你的对手是我！” 两人拳掌相交，郭靖只觉一股刚猛之力袭来，连退三步。
裘千仞大笑道：“黄药师的徒弟不过如此！”
黄蓉急道：“靖哥哥，他的铁掌刚猛，你用空明拳应对。”
郭靖依言使出周伯通所教的空明拳，招式灵动，裘千仞一时竟难以取胜。朱子柳也拔剑相助，两人夹击裘千仞。
一灯大师对黄蓉道：“女娃，我们开始疗伤。” 说着伸出右手食指，点在黄蓉胸前膻中穴。黄蓉只觉一股暖流涌入体内，疼痛顿时减轻不少。
禅房内拳风呼啸，郭靖与朱子柳合力，仍是难以压制裘千仞。裘千仞见一灯大师正全力疗伤，心中暗喜，虚晃一招，便向禅床扑去。
黄蓉急呼：“靖哥哥！” 郭靖见状，不顾一切扑上前，挡在禅床前，硬生生受了裘千仞一掌。他 “哇” 的一声，喷出一口鲜血。
一灯大师眉头一皱，左手一挥，一股内力将裘千仞逼退。裘千仞惊道：“你竟还能分心御敌！”。"""

async def run_test():
    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        print("❌ OPENROUTER_API_KEY not found")
        return

    print(f"Input text length: {len(TEST_TEXT)} chars")
    print("Analyzing...")
    
    try:
        result = await analyze_text(TEST_TEXT, api_key)
        script = result.get("script", [])
        
        print("\n=== Analysis Result ===")
        print(f"Total Segments: {len(script)}")
        print(f"Narration Segments: {sum(1 for s in script if s['type'] == 'narration')}")
        print(f"Dialogue Segments: {sum(1 for s in script if s['type'] == 'dialogue')}")
        
        print("\nLast 3 segments:")
        for i, seg in enumerate(script[-3:]):
            print(f"[{len(script)-3+i}] {seg['type']} ({seg.get('character', 'NA')}): {seg['text'][:30]}...")
            
    except Exception as e:
        print(f"❌ Error: {e}")

if __name__ == "__main__":
    asyncio.run(run_test())
